#include "MalwareHashBase.h"

#include <filesystem>
#include <string>
#include <iostream>
#include <cctype>
#include <algorithm>

constexpr std::string_view FILE_BASE_EXTENSION = ".csv";
constexpr int HASH_STRING_SIZE = 32;

static std::string str_tolower(std::string s) {
    std::transform(s.begin(), s.end(), s.begin(), [](unsigned char c){
        return std::tolower(c);
    });
    return s;
}

MalwareHashBase::MalwareHashBase() {}

MalwareHashBase::MalwareHashBase(const std::string& basePath) {
    m_basePath = basePath;
}

void MalwareHashBase::setBasePath(const std::string& basePath) {
    m_basePath = basePath;
    m_hashToVerdict.clear();
    m_baseFile.close();
    m_fileIndexed = false;
}

bool MalwareHashBase::checkLineFormat(std::string_view line) const {
    int separatorCount = 0;
    int separatorPosition = -1;
    for (int i = 0; i < line.size() && separatorCount <= 1; i++) {
        if (line[i] == ';') {
            separatorCount++;
            separatorPosition = i;
        }
    }
    return (separatorCount == 1 &&
            separatorPosition == HASH_STRING_SIZE &&
            separatorPosition != line.size()-1);
}

std::pair<Kaspersky::Hash, std::string>
MalwareHashBase::getHashAndVerdictFromString(const std::string &s) const {
    auto separatorPos = s.find(';');
    std::string_view hash(s.c_str(), separatorPos);
    return {Kaspersky::Hash::fromStringView(hash), s.substr(separatorPos + 1)};
}

BaseError MalwareHashBase::checkBaseFile() const noexcept {
    if (!std::filesystem::exists(m_basePath))
        return BaseError::NoSuchPath;
    if (std::filesystem::is_directory(m_basePath))
        return BaseError::NotAFile;
    if (auto fileExt = std::filesystem::path(m_basePath).extension().string();
            str_tolower(fileExt) != FILE_BASE_EXTENSION)
        return BaseError::WrongExtension;
    std::ifstream baseFile(m_basePath, std::ios::in);
    if (!baseFile.is_open())
        return BaseError::NoPermissions;
    std::string line;
    while(getline(baseFile, line)) {
        if (!checkLineFormat(line)) {
            return BaseError::WrongFormat;
        }
    }
    return BaseError::Ok;
}

void MalwareHashBase::indexBaseFileContent() {
    m_baseFile.open(m_basePath, std::ios::in);

    std::string line;
    while(getline(m_baseFile, line)) {
        auto [hash, verdict] = getHashAndVerdictFromString(line);
        m_hashToVerdict.emplace(hash, std::string(verdict));
    }
    m_baseFile.close();
    m_fileIndexed = true;
}

std::optional<std::string>
MalwareHashBase::findIndexedHashVerdict(const std::string &hash) const noexcept {
    return findIndexedHashVerdict(Kaspersky::Hash::fromString(hash));
}

std::optional<std::string>
MalwareHashBase::findIndexedHashVerdict(const Kaspersky::Hash &hash) const noexcept {
    if (auto it = m_hashToVerdict.find(hash); it != m_hashToVerdict.end())
        return it->second;
    return std::nullopt;
}
