#ifndef SRC_SCANNER_MALWAREHASHBASE_H_
#define SRC_SCANNER_MALWAREHASHBASE_H_

#include <fstream>
#include <map>
#include <cstdint>
#include <string>
#include <optional>
#include <utility>

#include "Hash.h"

enum class BaseError {
    Ok,
    NoSuchPath,
    NotAFile,
    WrongExtension,
    NoPermissions,
    WrongFormat
};

const std::map<BaseError, std::string_view> BASE_ERROR_MESSAGES {
    {BaseError::Ok,              "Base file is ok"},
    {BaseError::NoSuchPath,      "The specified base path does not exist"},
    {BaseError::NotAFile,        "The specified base path is not a file"},
    {BaseError::WrongExtension,  "Incorrect database file extension"},
    {BaseError::NoPermissions,   "No permissions to open the database file"},
    {BaseError::WrongFormat,     "Incorrect database format"},
};

///
/// \brief Класс отвечающий за чтение и поиск данных по файлу базы хэшей
///
class MalwareHashBase {
public:
    MalwareHashBase();
    explicit MalwareHashBase(const std::string& basePath);
    /// \brief Задание пути к файлу базы
    void setBasePath(const std::string& basePath);
    /// \brief Проверка файла базы
    /// \return Код ошибки
    BaseError checkBaseFile() const noexcept;
    /// \brief Индексирует содержимое файла базы
    /// Не является потокобезопасным методом
    /// Должен вызываться один раз на этапе инициализации, до любых параллельных запросов
    void indexBaseFileContent();
    /// \brief Ищет вердикт по заданному хэшу
    /// Потокобезопасен, при условии что база уже проиндексирована
    std::optional<std::string> findIndexedHashVerdict(const std::string &hash) const noexcept;
    /// \brief Ищет вердикт по заданному хэшу.
    /// Потокобезопасен, при условии что база уже проиндексирована
    std::optional<std::string> findIndexedHashVerdict(const Kaspersky::Hash &hash) const noexcept;
private:
    /// \brief Проверяет формат полученной строки
    bool checkLineFormat(std::string_view line) const;
    /// \brief Парсит пару хэш-вердикт из строки
    std::pair<Kaspersky::Hash, std::string> getHashAndVerdictFromString(const std::string &s) const;
private:
    std::map<Kaspersky::Hash, std::string> m_hashToVerdict; //!< пары хэш-вердикт
    std::string   m_basePath;                               //!< путь к файлу базы
    std::ifstream m_baseFile;                               //!< файл базы
    bool          m_fileIndexed = false;                    //!< файл базы проиндексирован
};

#endif // SRC_SCANNER_MALWAREHASHBASE_H_
