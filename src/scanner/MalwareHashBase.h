#ifndef MALWARE_HASH_BASE_H
#define MALWARE_HASH_BASE_H

#include <fstream>
#include <map>
#include <cstdint>
#include <string>
#include <optional>

#include "Hash.h"

enum class BaseError {
    Ok,
    NoSuchPath,
    NotAFile,
    WrongExtension,
    NoPermissions,
    WrongFormat
};

const std::map<BaseError, std::string_view> BASE_ERROR_MESSAGES {
    {BaseError::Ok,              "Base file is ok"},
    {BaseError::NoSuchPath,      "The specified base path does not exist"},
    {BaseError::NotAFile,        "The specified base path is not a file"},
    {BaseError::WrongExtension,  "Incorrect database file extension"},
    {BaseError::NoPermissions,   "No permissions to open the database file"},
    {BaseError::WrongFormat,     "Incorrect database format"},
};

class MalwareHashBase {
public:
    MalwareHashBase();
    explicit MalwareHashBase(const std::string& basePath);
    void setBasePath(const std::string& basePath);
    BaseError checkBaseFile() const noexcept;
    void indexBaseFileContent();
    std::optional<std::string> findIndexedHashVerdict(const std::string &hash) const noexcept;
    std::optional<std::string> findIndexedHashVerdict(const Kaspersky::Hash &hash) const noexcept;
private:
    bool checkLineFormat(std::string_view line) const;
    std::pair<Kaspersky::Hash, std::string> getHashAndVerdictFromString(const std::string &s) const;
private:
    std::map<Kaspersky::Hash, std::string> m_hashToVerdict; //!< пары хэш-вердикт
    std::string   m_basePath;                               //!< путь к файлу базы
    std::ifstream m_baseFile;                               //!< файл базы
    bool          m_fileIndexed = false;                    //!< файл базы проиндексирован
};

#endif // MALWARE_HASH_BASE_H
